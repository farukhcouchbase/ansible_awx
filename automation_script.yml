---
- name: Couchbase corruption scan (local node)
  hosts: all
  gather_facts: false

  vars:
    script_name: path.sh
    ubuntu_home: "/home/ubuntu"     # adjust if the home dir differs

  tasks:

    # 1 ▸ Copy the script to the remote node
    - name: Copy {{ script_name }} to ubuntu's home
      copy:
        src: "{{ playbook_dir }}/{{ script_name }}"
        dest: "{{ ubuntu_home }}/{{ script_name }}"
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    # 2 ▸ Ensure the script is executable (belt-and-braces)
    - name: Make {{ script_name }} executable
      become: true
      file:
        path: "{{ ubuntu_home }}/{{ script_name }}"
        mode: "0755"
        owner: ubuntu
        group: ubuntu

    # 3 ▸ Run the script with the flag chosen in the AWX survey
    - name: Run {{ script_name }} with chosen flag
      become: true
      become_user: ubuntu
      shell: |
        ./{{ script_name }} --{{ scan_flag | default('both') }} \
          > path.txt 2>&1
      args:
        chdir: "{{ ubuntu_home }}"
      environment:
        CB_USER: "{{ couch_user }}"
        CB_PASS: "{{ couch_pass }}"

    # 4 ▸ Read the output from path.txt into a variable
    - name: Read path.txt content
      become: true
      become_user: ubuntu
      shell: cat path.txt
      args:
        chdir: "{{ ubuntu_home }}"
      register: path_output

    # 5 ▸ Print first 20 lines of script output to terminal
    - name: Print first 20 lines of script output
      debug:
        msg: "{{ path_output.stdout_lines[:20] }}"

    # 6 ▸ Fetch the full path.txt to the control node
    - name: Fetch full path.txt to control node
      become: true
      fetch:
        src: "{{ ubuntu_home }}/path.txt"
        dest: "./path_output/{{ inventory_hostname }}.txt"
        flat: yes
