---
- name: Couchbase Index Resource Guard
  hosts: localhost
  gather_facts: no

  vars:
    couchbase_url: "http://34.233.0.93:8091/pools/default"
    couchbase_user: "Admin"       # üîë Update to your Couchbase admin
    couchbase_pass: "redhat"      # üîë Update to your Couchbase admin password

    alert_email_from: "couchbase-alerts@company.com"
    alert_email_to: "db-team@company.com"
    alert_smtp_host: "smtp.company.com"

  tasks:

    - name: Fetch Couchbase cluster info
      uri:
        url: "{{ couchbase_url }}"
        method: GET
        user: "{{ couchbase_user }}"
        password: "{{ couchbase_pass }}"
        force_basic_auth: yes
        return_content: yes
      register: clusterinfo

    - name: Extract Index Memory Quota (MB)
      set_fact:
        index_quota: "{{ clusterinfo.json.indexMemoryQuota | int }}"

    - name: Calculate index usage per node
      set_fact:
        index_usage_results: >-
          {{
            clusterinfo.json.nodes
            | selectattr('services', 'contains', 'index')
            | map(attribute='interestingStats.mem_used')
            | map('default', 0)
            | map('int')
            | list
          }}

    - name: Debug | Show raw index usage results per node
      debug:
        var: index_usage_results

    - name: Evaluate total index usage percent across all nodes
      set_fact:
        usage_percent: >-
          {{
            (
              (index_usage_results | map('int') | sum) /
              ((index_quota | int) * 1024 * 1024)
            ) * 100.0
            if (index_usage_results | length) > 0 else 0.0
          }}

    - name: Debug | Show calculated usage percent
      debug:
        msg: "Index usage percent = {{ usage_percent | float | round(2) }} % (Quota={{ index_quota | int }} MB)"

    - name: Compute blocking condition
      set_fact:
        block_triggered: >-
          {{
            (usage_percent | float >= 75.0) or
            (
              clusterinfo.json.nodes
              | selectattr('services','contains','index')
              | selectattr('status','ne','healthy')
              | list | length > 0
            )
          }}

    # ------------------
    # Clear Human Feedback
    # ------------------
    - name: Print status when under threshold and healthy
      debug:
        msg: "‚úÖ Couchbase Index usage is SAFE: {{ usage_percent | float | round(2) }}% used (below 75% threshold). Cluster healthy."
      when: not block_triggered | bool

    - name: Print status when threshold exceeded or unhealthy
      debug:
        msg: "‚ö†Ô∏è ALERT: Couchbase Index usage HIGH at {{ usage_percent | float | round(2) }}% (Threshold=75%). Blocking further index creation!"
      when: block_triggered | bool

    # ------------------
    # Fail & Notify if Issue
    # ------------------
    - name: Fail if usage exceeds threshold or unhealthy node found
      fail:
        msg: "Blocking index creation: Index usage at {{ usage_percent | float | round(2) }}% (Quota={{ index_quota | int }} MB)"
      when: block_triggered | bool

    - name: Send alert email if block triggered
      mail:
        host: "{{ alert_smtp_host }}"
        port: 25
        from: "{{ alert_email_from }}"
        to: "{{ alert_email_to }}"
        subject: "ALERT: Couchbase Index Creation Blocked"
        body: |
          Couchbase monitoring detected that index service usage exceeded threshold
          or index node is unhealthy.

          Current Usage: {{ usage_percent | float | round(2) }}%
          Quota: {{ index_quota | int }} MB

          Action: Index Creation BLOCKED
      when: block_triggered | bool
