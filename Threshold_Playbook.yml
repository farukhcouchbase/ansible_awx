---
- name: Couchbase Monitoring - Index, CPU, and Disk Usage
  hosts: all
  gather_facts: false

  vars:
    # ------------------------
    # Couchbase Credentials & API
    # ------------------------
    couchbase_user: "Admin"
    couchbase_password: "redhat"
    couchbase_host: "127.0.0.1"
    couchbase_port: 8091
    index_stats_port: 9102

    # ------------------------
    # Thresholds (as fraction of quota or %)
    # ------------------------
    quota_threshold: 0.75       # 75% by default
    cpu_threshold: 0.75         # 75% CPU usage
    disk_threshold: 0.75        # 75% disk usage

    # ------------------------
    # Webhook for notifications
    # ------------------------
    webhook_url: "https://webhook.site/cdf4536e-6275-4ab8-9d3d-873bea3fc777"

  tasks:

    # ------------------------
    # Step 1: Fetch Couchbase Cluster Info
    # ------------------------
    - name: Get Couchbase cluster JSON
      uri:
        url: "http://{{ couchbase_host }}:{{ couchbase_port }}/pools/default"
        method: GET
        return_content: yes
        user: "{{ couchbase_user }}"
        password: "{{ couchbase_password }}"
        force_basic_auth: yes
      register: api_response

    - name: Show HTTP status
      debug:
        msg: "HTTP Status: {{ api_response.status }}"

    # ------------------------
    # Step 2: INDEX MEMORY USAGE
    # ------------------------
    - name: Get Couchbase index stats using curl
      shell: "curl -s -u {{ couchbase_user }}:{{ couchbase_password }} http://localhost:{{ index_stats_port }}/stats"
      register: stats_response

    - name: Parse index stats JSON
      set_fact:
        stats_json: "{{ stats_response.stdout | from_json }}"

    - name: Extract index quota and usage
      set_fact:
        index_quota_bytes: "{{ api_response.json.indexMemoryQuota | int * 1000000 }}"
        index_quota_threshold_bytes: "{{ (index_quota_bytes * quota_threshold) | round(0) | int }}"
        index_memory_used_bytes: "{{ stats_json.memory_used | int }}"
        index_memory_used_mib: "{{ (index_memory_used_bytes / 1024 / 1024) | round(2) }}"
        index_quota_threshold_mib: "{{ (index_quota_threshold_bytes / 1024 / 1024) | round(2) }}"

    - name: Debug index usage
      debug:
        msg: >
          Index Memory Used: {{ index_memory_used_mib }} MiB
          Threshold: {{ index_quota_threshold_mib }} MiB

    - name: Alert if Index memory exceeds threshold
      debug:
        msg: "âŒ ALERT: Index Memory usage ({{ index_memory_used_mib }} MiB) exceeds threshold ({{ index_quota_threshold_mib }} MiB)!"
      when: index_memory_used_bytes > index_quota_threshold_bytes

    - name: OK if Index memory under threshold
      debug:
        msg: "âœ… Index Memory usage ({{ index_memory_used_mib }} MiB) is under threshold ({{ index_quota_threshold_mib }} MiB)."
      when: index_memory_used_bytes <= index_quota_threshold_bytes

    - name: Send Index Memory ALERT to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "ðŸš¨ Couchbase Index Memory Alert on {{ inventory_hostname }}"
          body: >
            ALERT: Index memory usage is above threshold!
            Used: {{ index_memory_used_mib }} MiB
            Threshold: {{ index_quota_threshold_mib }} MiB
      when: index_memory_used_bytes > index_quota_threshold_bytes

    - name: Send Index Memory OK notification to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "âœ… Couchbase Index Memory OK on {{ inventory_hostname }}"
          body: >
            Index memory usage is within safe limits.
            Used: {{ index_memory_used_mib }} MiB
            Threshold: {{ index_quota_threshold_mib }} MiB
      when: index_memory_used_bytes <= index_quota_threshold_bytes

    # ------------------------
    # Step 3: CPU USAGE
    # ------------------------
    - name: Extract CPU usage from JSON (max across nodes)
      set_fact:
        cpu_used_percent: "{{ api_response.json.nodes | map(attribute='systemStats.cpu_utilization_rate') | max }}"
        cpu_threshold_percent: "{{ cpu_threshold * 100 }}"

    - name: Debug CPU usage
      debug:
        msg: "CPU Usage: {{ cpu_used_percent }}% (Threshold: {{ cpu_threshold_percent }}%)"

    - name: Alert if CPU exceeds threshold
      debug:
        msg: "âŒ ALERT: CPU usage ({{ cpu_used_percent }}%) exceeds threshold ({{ cpu_threshold_percent }}%)!"
      when: cpu_used_percent > cpu_threshold_percent

    - name: OK if CPU under threshold
      debug:
        msg: "âœ… CPU usage ({{ cpu_used_percent }}%) is under threshold ({{ cpu_threshold_percent }}%)."
      when: cpu_used_percent <= cpu_threshold_percent

    - name: Send CPU ALERT to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "ðŸš¨ Couchbase CPU Alert on {{ inventory_hostname }}"
          body: >
            ALERT: CPU usage is above threshold!
            CPU Usage: {{ cpu_used_percent }}%
            Threshold: {{ cpu_threshold_percent }}%
      when: cpu_used_percent > cpu_threshold_percent

    - name: Send CPU OK notification to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "âœ… Couchbase CPU OK on {{ inventory_hostname }}"
          body: >
            CPU usage is within safe limits.
            CPU Usage: {{ cpu_used_percent }}%
            Threshold: {{ cpu_threshold_percent }}%
      when: cpu_used_percent <= cpu_threshold_percent

    # ------------------------
    # Step 4: DISK USAGE
    # ------------------------
    - name: Extract Disk usage from JSON
      set_fact:
        disk_used_bytes: "{{ api_response.json.storageTotals.hdd.used }}"
        disk_total_bytes: "{{ api_response.json.storageTotals.hdd.total }}"
        disk_used_percent: "{{ (disk_used_bytes / disk_total_bytes * 100) | round(2) }}"
        disk_threshold_percent: "{{ disk_threshold * 100 }}"

    - name: Debug Disk usage
      debug:
        msg: "Disk Usage: {{ disk_used_percent }}% (Threshold: {{ disk_threshold_percent }}%)"

    - name: Alert if Disk exceeds threshold
      debug:
        msg: "âŒ ALERT: Disk usage ({{ disk_used_percent }}%) exceeds threshold ({{ disk_threshold_percent }}%)!"
      when: disk_used_percent > disk_threshold_percent

    - name: OK if Disk under threshold
      debug:
        msg: "âœ… Disk usage ({{ disk_used_percent }}%) is under threshold ({{ disk_threshold_percent }}%)."
      when: disk_used_percent <= disk_threshold_percent

    - name: Send Disk ALERT to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "ðŸš¨ Couchbase Disk Alert on {{ inventory_hostname }}"
          body: >
            ALERT: Disk usage is above threshold!
            Disk Usage: {{ disk_used_percent }}%
            Threshold: {{ disk_threshold_percent }}%
      when: disk_used_percent > disk_threshold_percent

    - name: Send Disk OK notification to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "âœ… Couchbase Disk OK on {{ inventory_hostname }}"
          body: >
            Disk usage is within safe limits.
            Disk Usage: {{ disk_used_percent }}%
            Threshold: {{ disk_threshold_percent }}%
      when: disk_used_percent <= disk_threshold_percent
