---
- name: Couchbase Quota and Memory Usage Check
  hosts: all
  gather_facts: false

  tasks:
    - name: Get JSON from Couchbase API with authentication
      uri:
        url: "http://52.1.194.209:8091/pools/default"
        method: GET
        return_content: yes
        user: "Administrator"
        password: "redhat"
        force_basic_auth: yes
      register: api_response

    - name: Show HTTP status
      debug:
        msg: "HTTP Status: {{ api_response.status }}"

    - name: Print indexMemoryQuota (MB from Couchbase API)
      debug:
        msg: "Index Memory Quota (MB): {{ api_response.json.indexMemoryQuota | default('Key not found') }}"

    # ✅ Convert quota MB -> bytes and calculate 75%
    - name: Calculate 75% of indexMemoryQuota in bytes
      set_fact:
        quota_75_bytes: "{{ (api_response.json.indexMemoryQuota | int * 1000000 * 0.75) | round(0) | int }}"

    - name: Print 75% of indexMemoryQuota (bytes and MiB)
      debug:
        msg: >
          75% of Index Memory Quota:
          {{ quota_75_bytes }} bytes
          ({{ (quota_75_bytes | int / 1024 / 1024) | round(2) }} MiB)

    - name: Get Couchbase index stats using curl
      shell: >
        curl -s -u Administrator:redhat http://localhost:9102/stats
      register: stats_response

    - name: Parse stats JSON
      set_fact:
        stats_json: "{{ stats_response.stdout | from_json }}"

    - name: Print memory_used (bytes)
      debug:
        msg: "Memory Used: {{ stats_json.memory_used | default('Key not found') }} bytes"

    # ✅ Convert memory_used into MiB for readability
    - name: Convert memory_used into MiB
      set_fact:
        memory_used_mib: "{{ (stats_json.memory_used | int / 1024 / 1024) | round(2) }}"

    - name: Print memory_used in MiB
      debug:
        msg: "Memory Used: {{ memory_used_mib }} MiB"

    # ✅ Alert/fail condition
    - name: Fail if memory_used exceeds 75% of quota
      fail:
        msg: "❌ ALERT: Memory usage ({{ memory_used_mib }} MiB) exceeded 75% of quota ({{ (quota_75_bytes | int / 1024 / 1024) | round(2) }} MiB). Index creation is blocked."
      when: (stats_json.memory_used | int) > (quota_75_bytes | int)

    - name: Threshold safe check
      debug:
        msg: "✅ Memory usage ({{ memory_used_mib }} MiB) is below 75% of quota ({{ (quota_75_bytes | int / 1024 / 1024) | round(2) }} MiB). Index creation/build is allowed."
      when: (stats_json.memory_used | int) <= (quota_75_bytes | int)

    - name: Fail if memory_used exceeds 75% of quota
      fail:
        msg: "❌ ALERT: Memory usage ({{ memory_used_mib }} MiB) exceeded 75% of quota ({{ (quota_75_bytes | int / 1024 / 1024) | round(2) }} MiB). Index creation is blocked."
      when: (stats_json.memory_used | int) > (quota_75_bytes | int)

    - name: Threshold safe check
      debug:
        msg: "✅ Memory usage ({{ memory_used_mib }} MiB) is below 75% of quota ({{ (quota_75_bytes | int / 1024 / 1024) | round(2) }} MiB). Index creation/build is allowed."
      when: (stats_json.memory_used | int) <= (quota_75_bytes | int)

    - name: Ping to prove calculation works
      ping:
      when: (stats_json.memory_used | int) <= (quota_75_bytes | int)
