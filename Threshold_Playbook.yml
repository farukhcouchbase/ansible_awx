---
- name: Couchbase Monitoring - Index, CPU, and Disk Usage (Safe Defaults)
  hosts: all
  gather_facts: false

  vars:
    # ------------------------
    # Couchbase Credentials & API
    # ------------------------
    couchbase_user: "Admin"
    couchbase_password: "redhat"
    couchbase_host: "127.0.0.1"
    couchbase_port: 8091
    index_stats_port: 9102

    # ------------------------
    # Thresholds (fraction or %)
    # ------------------------
    quota_threshold: 0.75       # Index memory usage threshold
    cpu_threshold: 0.75         # CPU usage threshold
    disk_threshold: 0.75        # Disk usage threshold

    # ------------------------
    # Webhook for notifications
    # ------------------------
    webhook_url: "https://webhook.site/cdf4536e-6275-4ab8-9d3d-873bea3fc777"

    # ------------------------
    # Safe defaults if API returns nothing
    # ------------------------
    default_index_quota_mb: 256
    default_cpu_percent: 0
    default_disk_total_bytes: 1
    default_disk_used_bytes: 0

  tasks:

    # ------------------------
    # Step 1: Fetch Couchbase Cluster Info
    # ------------------------
    - name: Get Couchbase cluster JSON
      uri:
        url: "http://{{ couchbase_host }}:{{ couchbase_port }}/pools/default"
        method: GET
        return_content: yes
        user: "{{ couchbase_user }}"
        password: "{{ couchbase_password }}"
        force_basic_auth: yes
      register: api_response

    - name: Show cluster JSON (debug)
      debug:
        var: api_response.json

    # ------------------------
    # Step 2: INDEX MEMORY USAGE
    # ------------------------
    - name: Get Couchbase index stats using curl
      shell: "curl -s -u {{ couchbase_user }}:{{ couchbase_password }} http://localhost:{{ index_stats_port }}/stats"
      register: stats_response
      ignore_errors: yes

    - name: Parse index stats JSON safely
      set_fact:
        stats_json: "{{ stats_response.stdout | default('{}') | from_json }}"

    # Step 2a: Extract quota and memory used safely
    - name: Set index quota and memory used
      set_fact:
        index_quota_bytes: "{{ ((api_response.json.indexMemoryQuota | default(default_index_quota_mb)) | int * 1000000) | int }}"
        index_memory_used_bytes: "{{ stats_json.memory_used | default(0) | int }}"

    # Step 2b: Calculate threshold and convert to MiB safely
    - name: Calculate index threshold and convert to MiB
      set_fact:
        index_quota_threshold_bytes: "{{ ((index_quota_bytes | default(default_index_quota_mb * 1000000)) | int * (quota_threshold | float)) | round(0) | int }}"
        index_memory_used_mib: "{{ (index_memory_used_bytes | int / 1024 / 1024) | round(2) }}"
        index_quota_threshold_mib: "{{ (index_quota_threshold_bytes | int / 1024 / 1024) | round(2) }}"

    - name: Debug index usage
      debug:
        msg: "Index Memory Used: {{ index_memory_used_mib }} MiB (Threshold: {{ index_quota_threshold_mib }} MiB)"

    - name: Index Memory ALERT/OK
      debug:
        msg: >-
          {% if index_memory_used_bytes > index_quota_threshold_bytes %}
          ❌ ALERT: Index Memory usage exceeds threshold!
          {% else %}
          ✅ Index Memory usage is within safe limits.
          {% endif %}

    - name: Send Index Memory notification to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "{% if index_memory_used_bytes > index_quota_threshold_bytes %}🚨 Couchbase Index Memory Alert{% else %}✅ Couchbase Index Memory OK{% endif %} on {{ inventory_hostname }}"
          body: >
            Index Memory Usage: {{ index_memory_used_mib }} MiB
            Threshold: {{ index_quota_threshold_mib }} MiB

    # ------------------------
    # Step 3: CPU USAGE
    # ------------------------
    - name: Extract CPU usage safely (max across nodes)
      set_fact:
        cpu_used_percent: "{{ api_response.json.nodes | default([]) | map(attribute='systemStats.cpu_utilization_rate') | list | max | default(default_cpu_percent) | float }}"
        cpu_threshold_percent: "{{ (cpu_threshold * 100) | float }}"

    - name: Debug CPU usage
      debug:
        msg: "CPU Usage: {{ cpu_used_percent }}% (Threshold: {{ cpu_threshold_percent }}%)"

    - name: CPU ALERT/OK
      debug:
        msg: >-
          {% if cpu_used_percent > cpu_threshold_percent %}
          ❌ ALERT: CPU usage exceeds threshold!
          {% else %}
          ✅ CPU usage is within safe limits.
          {% endif %}

    - name: Send CPU notification to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "{% if cpu_used_percent > cpu_threshold_percent %}🚨 Couchbase CPU Alert{% else %}✅ Couchbase CPU OK{% endif %} on {{ inventory_hostname }}"
          body: >
            CPU Usage: {{ cpu_used_percent }}%
            Threshold: {{ cpu_threshold_percent }}%

    # ------------------------
    # Step 4: DISK USAGE
    # ------------------------
    - name: Extract Disk usage safely from JSON
      set_fact:
        disk_used_bytes: "{{ api_response.json.storageTotals.hdd.used | default(default_disk_used_bytes) | int }}"
        disk_total_bytes: "{{ api_response.json.storageTotals.hdd.total | default(default_disk_total_bytes) | int }}"

    - name: Calculate disk usage percentage safely
      set_fact:
        disk_used_percent: "{{ ((disk_used_bytes | float / disk_total_bytes | float) * 100) | round(2) }}"
        disk_threshold_percent: "{{ (disk_threshold * 100) | float }}"

    - name: Debug Disk usage
      debug:
        msg: "Disk Usage: {{ disk_used_percent }}% (Threshold: {{ disk_threshold_percent }}%)"

    - name: Disk ALERT/OK
      debug:
        msg: >-
          {% if disk_used_percent > disk_threshold_percent %}
          ❌ ALERT: Disk usage exceeds threshold!
          {% else %}
          ✅ Disk usage is within safe limits.
          {% endif %}

    - name: Send Disk notification to webhook
      uri:
        url: "{{ webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          subject: "{% if disk_used_percent > disk_threshold_percent %}🚨 Couchbase Disk Alert{% else %}✅ Couchbase Disk OK{% endif %} on {{ inventory_hostname }}"
          body: >
            Disk Usage: {{ disk_used_percent }}%
            Threshold: {{ disk_threshold_percent }}%
