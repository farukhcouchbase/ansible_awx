---
- name: Couchbase Index Resource Guard
  hosts: 34.233.0.93
  gather_facts: no

  vars:
    couchbase_url: "http://34.233.0.93:8091/pools/default"
    couchbase_user: "Admin"
    couchbase_pass: "redhat"
    alert_email_from: "couchbase-alerts@company.com"
    alert_email_to: "db-team@company.com"
    alert_smtp_host: "smtp.company.com"

  tasks:

    - name: Fetch Couchbase cluster info
      uri:
        url: "{{ couchbase_url }}"
        method: GET
        user: "{{ couchbase_user }}"
        password: "{{ couchbase_pass }}"
        force_basic_auth: yes
        return_content: yes
      register: clusterinfo

    - name: Extract Index Memory Quota
      set_fact:
        index_quota: "{{ clusterinfo.json.indexMemoryQuota }}"

    - name: Calculate index usage per node
      set_fact:
        index_usage_results: >-
          {{
            clusterinfo.json.nodes
            | selectattr('services', 'contains', 'index')
            | map(attribute='interestingStats.mem_used')
            | map('default', 0)
            | map('int')
            | list
          }}

    - name: Evaluate index usage percent
      set_fact:
        usage_percent: "{{ (index_usage_results[0] / (index_quota * 1024 * 1024)) * 100 if index_usage_results|length > 0 else 0 }}"

    - name: Fail if usage exceeds 75% or unhealthy nodes
      fail:
        msg: "Blocking index creation: Index usage at {{ usage_percent | round(2) }}% (Quota={{index_quota}} MB)"
      when: usage_percent | float >= 75 or
            (clusterinfo.json.nodes | selectattr('services','contains','index') | selectattr('status','ne','healthy') | list | length > 0)

    - name: Send alert email if block triggered
      mail:
        host: "{{ alert_smtp_host }}"
        port: 25
        from: "{{ alert_email_from }}"
        to: "{{ alert_email_to }}"
        subject: "ALERT: Couchbase Index Creation Blocked"
        body: |
          Couchbase monitoring detected that index service usage exceeded threshold
          or index node is unhealthy.

          Current Usage: {{ usage_percent | round(2) }}%
          Quota: {{ index_quota }} MB
          Action: Index Creation BLOCKED

      when: usage_percent | float >= 75 or
            (clusterinfo.json.nodes | selectattr('services','contains','index') | selectattr('status','ne','healthy') | list | length > 0)
