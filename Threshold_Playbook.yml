- name: Couchbase Index Creation with Resource Check
  hosts: 34.233.0.93
  gather_facts: no
  vars:
    couchbase_host: "127.0.0.1"
    couchbase_admin: "Admin"
    couchbase_password: "redhat"
    mail_to: "ritikredhat@gmail.com"
    mail_from: "ritik.lodha.cn@gmail.com"
    smtp_host: "smtp.yourcompany.com"
    smtp_port: 25

  tasks:
    - name: Get Couchbase cluster stats
      uri:
        url: "http://{{ couchbase_host }}:8091/pools/default"
        method: GET
        user: "{{ couchbase_admin }}"
        password: "{{ couchbase_password }}"
        force_basic_auth: yes
        return_content: yes
      register: cb_stats

    - name: Debug cluster stats (optional)
      debug:
        var: cb_stats.json.nodes[0]
      when: cb_stats.json.nodes is defined

    - name: Parse node stats (first node)
      set_fact:
        cpu_util: "{{ (cb_stats.json.nodes[0].systemStats.cpu_utilization_rate
                      | default(cb_stats.json.nodes[0].systemStats.cpu_utilization)
                      | default(cb_stats.json.nodes[0].interestingStats.cpu_utilization_rate)
                      | default(0)) | float }}"
        mem_total: "{{ (cb_stats.json.nodes[0].memoryTotal | default(1)) | float }}"
        mem_free: "{{ (cb_stats.json.nodes[0].memoryFree  | default(0)) | float }}"
        disk_total: "{{ (cb_stats.json.nodes[0].diskTotal | default(1)) | float }}"
        disk_free: "{{ (cb_stats.json.nodes[0].diskFree  | default(0)) | float }}"

    - name: Calculate memory and disk utilization %
      set_fact:
        mem_util: "{{ (1 - (mem_free / mem_total)) * 100 }}"
        disk_util: "{{ (1 - (disk_free / disk_total)) * 100 }}"

    - name: Fail and notify if utilization > 75%
      block:
        - name: Send email alert if threshold exceeded
          mail:
            host: "{{ smtp_host }}"
            port: "{{ smtp_port }}"
            from: "{{ mail_from }}"
            to: "{{ mail_to }}"
            subject: "Couchbase Index Creation Blocked"
            body: >
              Index creation was blocked due to high utilization:
              CPU={{ cpu_util|round(1) }}%,
              MEM={{ mem_util|round(1) }}%,
              DISK={{ disk_util|round(1) }}%.
        - name: Fail the play
          fail:
            msg: >
              Blocking index creation - Utilization limits exceeded.
              CPU={{ cpu_util|round(1) }}%,
              MEM={{ mem_util|round(1) }}%,
              DISK={{ disk_util|round(1) }}%
      when: cpu_util > 75 or mem_util > 75 or disk_util > 75

    - name: Run index creation only if healthy
      command: >
        couchbase-cli n1ql-query -c {{ couchbase_host }}:8091
        -u {{ couchbase_admin }} -p {{ couchbase_password }}
        --statement="CREATE INDEX idx_sample ON `bucket`(field);"
      when: cpu_util <= 75 and mem_util <= 75 and disk_util <= 75
