---
- name: Manage Couchbase indexes
  hosts: all
  become: yes
  tasks:
    - name: Ensure jq is installed
      apt:
        name: jq
        state: present
        update_cache: yes

    - name: Validate index file existence
      ansible.builtin.stat:
        path: /home/ubuntu/index_file.txt
      register: index_file_stat

    - name: Fail if index file is missing
      fail:
        msg: "Index file not found: /home/ubuntu/index_file.txt"
      when: not index_file_stat.stat.exists

    - name: Read and decode index file
      ansible.builtin.slurp:
        src: /home/ubuntu/index_file.txt
      register: index_file_content

    - name: Extract index creation SQL
      set_fact:
        index_creation_statements: "{{ (index_file_content.content | b64decode) | regex_findall('CREATE INDEX.*?;') }}"

    - name: Validate Couchbase CLI availability
      shell: "/home/ubuntu/bin/cbq --version"
      register: cbq_check
      changed_when: false

    - name: Create indexes
      shell: "/home/ubuntu/bin/cbq -u Admin -p redhat -s '{{ item }}'"
      with_items: "{{ index_creation_statements }}"
      ignore_errors: true
      register: ddl_output

    - name: Build indexes
      shell: |
        /home/ubuntu/bin/cbq -u Admin -p redhat -s "
        BUILD INDEX ON {{ item.1 }}.{{ item.2 }}.{{ item.3 }} ({{ item.4 }});
        "
      with_items: "{{ decoded_index_file_content | regex_findall('CREATE INDEX `([^`]+)` ON `([^`]+)`\\.(`[^`]+`)\\.`([^`]+)`\\(([^)]+)\\)') }}"
      register: build_output
      ignore_errors: true

    - name: Ensure tasks succeeded
      fail:
        msg: "Index creation or build tasks failed. Check outputs."
      when: ddl_output is failed or build_output is failed
