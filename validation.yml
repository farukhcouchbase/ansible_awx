---
- name: Create valid Couchbase indexes
  hosts: all  # Adjust this to your specific Couchbase host or group
  become: yes
  become_user: ubuntu
  vars:
    couchbase_host: "localhost"  # Replace with your Couchbase hostname or IP
    couchbase_username: "admin"  # Replace with your Couchbase admin username
    couchbase_password: "password"  # Replace with your Couchbase admin password
    cbq_path: "/opt/couchbase/bin/cbq"  # Ensure this is the correct path to your cbq command

  tasks:
    - name: Read index file content
      ansible.builtin.slurp:
        src: /home/ubuntu/Couchbase_UPS/index_file.txt
      register: index_file_content

    - name: Decode base64 content and split into lines using regex
      set_fact:
        index_lines: "{{ index_file_content.content | b64decode }}"

    # Debug decoded index file content
    - name: Debug decoded index file content
      debug:
        msg: "{{ index_lines }}"

    - name: Filter valid index creation queries
      set_fact:
        valid_queries: |
          {%- set valid = [] -%}
          {%- for line in index_lines -%}
            {%- if line is search('CREATE INDEX') and line is not search('PRIMARY INDEX') -%}
              {%- if line is search('"defer_build":true') -%}
                {%- if line is search('WHERE') -%}
                  {%- set valid = valid + [line] -%}  # Correct way to append to a list in Jinja2
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ valid }}

    - name: Show filtered valid index creation queries
      debug:
        msg: "{{ valid_queries }}"

    - name: Create the valid indexes using shell (cbq)
      shell: |
        echo "{{ item }}" | {{ cbq_path }} -u "{{ couchbase_username }}" -p "{{ couchbase_password }}" -s "{{ couchbase_host }}"
      loop: "{{ valid_queries }}"
      when: valid_queries | length > 0
      register: index_creation_result
      ignore_errors: yes  # Optional: allows the playbook to continue even if a query fails

    - name: Show result of index creation
      debug:
        msg: "{{ index_creation_result }}"
