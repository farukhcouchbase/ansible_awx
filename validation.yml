---
- name: Validate and Create Couchbase Indexes
  hosts: all
  gather_facts: no
  vars:
    couchbase_host: "127.0.0.1"
    couchbase_bin_path: "/opt/couchbase/bin/cbq"
    couchbase_admin_username: "Admin"
    couchbase_admin_password: "redhat"
    index_queries: []  # This comes from the Ansible survey

  tasks:
    - name: Identify and categorize index queries
      set_fact:
        allowed_queries: []
        not_allowed_queries: []

    - name: Validate index queries
      set_fact:
        allowed_queries: "{{ allowed_queries + [item] }}"
      when: 
        - "not item | regex_search('CREATE PRIMARY INDEX', ignorecase=True)"
        - "item | regex_search('CREATE INDEX', ignorecase=True)"
        - "item | regex_search('WHERE', ignorecase=True)"
      with_items: "{{ index_queries }}"

    - name: Identify not allowed queries
      set_fact:
        not_allowed_queries: "{{ not_allowed_queries + [item] }}"
      when: 
        - "item | regex_search('CREATE PRIMARY INDEX', ignorecase=True) or not item | regex_search('WHERE', ignorecase=True)"
      with_items: "{{ index_queries }}"

    - name: Debug - Allowed Queries
      debug:
        msg: "Allowed Index Query: {{ item }}"
      with_items: "{{ allowed_queries }}"

    - name: Debug - Not Allowed Queries
      debug:
        msg: "Not Allowed Index Query: {{ item }}"
      with_items: "{{ not_allowed_queries }}"

    - name: Execute allowed index queries
      command: >
        {{ couchbase_bin_path }} -e="{{ item }}" -u {{ couchbase_admin_username }} -p {{ couchbase_admin_password }}
      with_items: "{{ allowed_queries }}"
      when: allowed_queries | length > 0
      register: query_result

    - name: Debug - Query execution results
      debug:
        var: query_result
      when: allowed_queries | length > 0
