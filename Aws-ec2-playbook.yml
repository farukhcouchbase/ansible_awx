---
- name: Create EC2 Instances
  hosts:  localhost
  connection: local
  gather_facts: no

  vars:
    region: "us-east-1"
    key_name: "Couchbase-cluster"
    instance_type: "t2.medium"
    ami_id: "ami-0e1bed4f06a3b463d"
    security_groups: "default"
    #nstance_count: []
    tag_name: "Instance"

  tasks:
    - name: Create EC2 instances
      ec2_instance:
        region: "us-east-1"
        key_name: "{{ key_name }}"
        instance_type: "{{ instance_type }}"
        image_id: "{{ ami_id }}"
        security_groups: "{{ security_groups }}"
        network:
          assign_public_ip: true
        state: present
        tags:
          Name: "{{ tag_name }}"
      #loop: "{{ range(1, instance_count + 1) | list }}"
      register: ec2

    - name: Print instance details
      debug:
        msg: "Instance ID: {{ item.instance_id }}, Public IP: {{ item.public_ip_address | default('N/A') }}"
      loop: "{{ ec2.instances }}"
      when: ec2.instances is defined  

    # - name: Print instance details
    #   debug:
    #     msg: "Instance ID: {{ item.instance_id }}, Public IP: {{ item.public_ip_address | default('N/A') }}"
    #   loop: "{{ ec2.results | map(attribute='instances') | list | flatten }}"
    #   when: ec2.results is defined
